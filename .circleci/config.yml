version: 2.1

# Define Docker executor for building images
executors:
  docker-publisher:
    docker:
      - image: docker:dind
    environment:
      DOCKER_TLS_CERTDIR: ""
    privileged: true
  
jobs:
  build-and-push:
    executor: docker-publisher
    steps:
      - checkout
      
      - run:
          name: Start Docker daemon
          command: |
            dockerd-entrypoint.sh &
            sleep 5
            docker info
      
      - run:
          name: Set environment variables
          command: |
            export IMAGE_NAME="moindev/practify"
            export IMAGE_TAG="${CIRCLE_SHA1:0:7}"
            echo "Building image: ${IMAGE_NAME}:${IMAGE_TAG}"
            echo "IMAGE_NAME=${IMAGE_NAME}" >> $BASH_ENV
            echo "IMAGE_TAG=${IMAGE_TAG}" >> $BASH_ENV
      
      - run:
          name: Login to Docker Hub
          command: |
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      
      - run:
          name: Build Docker image
          command: |
            source $BASH_ENV
            docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
            docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
      
      - run:
          name: Push Docker image
          command: |
            source $BASH_ENV
            docker push ${IMAGE_NAME}:${IMAGE_TAG}
            docker push ${IMAGE_NAME}:latest
            echo "Successfully pushed ${IMAGE_NAME}:${IMAGE_TAG} and ${IMAGE_NAME}:latest"

  deploy-accessories:
    executor:
      docker:
        - image: kamal/simple-ruby-docker
    steps:
      - checkout
      
      
      - run:
          name: Install sshpass and setup SSH keys
          command: |
            apt-get update && apt-get install -y sshpass
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            # Generate SSH key pair
            ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N "" -q
            # Add server to known_hosts
            ssh-keyscan -H $DOMAIN >> ~/.ssh/known_hosts 2>/dev/null || true
            # Copy public key to server using password authentication
            export SSHPASS=$VM_INSTANCE_PASSWORD
            sshpass -e ssh-copy-id -o StrictHostKeyChecking=no root@$DOMAIN || true
            # Test SSH connection
            ssh -o StrictHostKeyChecking=no root@$DOMAIN "echo 'SSH key authentication successful'"
      
      - run:
          name: Boot PostgreSQL accessory
          command: |
            kamal accessory boot db
      
      - run:
          name: Boot Redis accessory
          command: |
            kamal accessory boot redis

workflows:
  main:
    jobs:
      - build-and-push
      - deploy-accessories:
          requires:
            - build-and-push
