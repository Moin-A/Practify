version: 2.1

# Define Docker executor for building images
executors:
  docker-publisher:
    docker:
      - image: docker:dind
  
jobs:
  build-and-push:
    executor: docker-publisher
    steps:
      - checkout
      
      - setup_remote_docker:
          docker_layer_caching: true
      
      - run:
          name: Set environment variables
          command: |
            export IMAGE_NAME="moindev/practify"
            export IMAGE_TAG="${CIRCLE_SHA1:0:7}"
            echo "Building image: ${IMAGE_NAME}:${IMAGE_TAG}"
            echo "IMAGE_NAME=${IMAGE_NAME}" >> $BASH_ENV
            echo "IMAGE_TAG=${IMAGE_TAG}" >> $BASH_ENV
      
      - run:
          name: Login to Docker Hub
          command: |
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      
      - run:
          name: Build Docker image
          command: |
            source $BASH_ENV
            docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
            docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
      
      - run:
          name: Push Docker image
          command: |
            source $BASH_ENV
            docker push ${IMAGE_NAME}:${IMAGE_TAG}
            docker push ${IMAGE_NAME}:latest
            echo "Successfully pushed ${IMAGE_NAME}:${IMAGE_TAG} and ${IMAGE_NAME}:latest"

  deploy:
    docker:
      - image: cimg/ruby:3.1
    steps:
      - checkout

      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Install Kamal
          command: |
             gem install kamal -v 1.5.0
      
      - run:
          name: Install sshpass and setup SSH keys
          command: |
            sudo apt-get update && sudo apt-get install -y sshpass
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            # Remove existing SSH keys if any
            rm -f ~/.ssh/id_rsa ~/.ssh/id_rsa.pub
            # Generate SSH key pair
            ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N "" -q
            # Add server to known_hosts
            ssh-keyscan -H $DOMAIN >> ~/.ssh/known_hosts 2>/dev/null || true
            # Copy public key to server using password authentication
            export SSHPASS=$VM_INSTANCE_PASSWORD
            sshpass -e ssh-copy-id -o StrictHostKeyChecking=no root@$DOMAIN || true
            # Test SSH connection
            ssh -o StrictHostKeyChecking=no root@$DOMAIN "echo 'SSH key authentication successful'"
      
      - run:
          name: Boot PostgreSQL accessory
          command: |
            kamal accessory boot db || echo "Database might already be running"
      
      - run:
          name: Boot Redis accessory
          command: |
            kamal accessory boot redis || echo "Redis might already be running"
      
      - run:
          name: Stop conflicting services
          command: |
            echo "Stopping nginx, apache, and existing Traefik..."
            # Stop nginx, apache
            ssh -o StrictHostKeyChecking=no root@$DOMAIN "sudo systemctl stop nginx 2>/dev/null || true"
            ssh -o StrictHostKeyChecking=no root@$DOMAIN "sudo systemctl stop apache2 2>/dev/null || true"
            ssh -o StrictHostKeyChecking=no root@$DOMAIN "sudo systemctl disable nginx 2>/dev/null || true"
            ssh -o StrictHostKeyChecking=no root@$DOMAIN "sudo systemctl disable apache2 2>/dev/null || true"
            # Stop and remove existing Traefik container
            ssh -o StrictHostKeyChecking=no root@$DOMAIN "docker stop traefik 2>/dev/null || true"
            ssh -o StrictHostKeyChecking=no root@$DOMAIN "docker rm traefik 2>/dev/null || true"
            echo "✅ Conflicting services stopped"

      - run:
          name: Boot Traefik with SSL
          command: |
            echo "Booting Traefik with SSL configuration..."
            LETSENCRYPT_EMAIL_VALUE="${LETSENCRYPT_EMAIL:-admin@practify.co.in}"
            echo "Using Let's Encrypt email: $LETSENCRYPT_EMAIL_VALUE"
            
            # Create letsencrypt directory
            ssh -o StrictHostKeyChecking=no root@$DOMAIN "mkdir -p /opt/letsencrypt && chmod 755 /opt/letsencrypt"
            
            # Start Traefik
            ssh -o StrictHostKeyChecking=no root@$DOMAIN "docker run --name traefik --detach --restart unless-stopped --publish 80:80 --publish 443:443 --volume /var/run/docker.sock:/var/run/docker.sock --volume /opt/letsencrypt:/letsencrypt --log-opt max-size=10m traefik:v2.10 --providers.docker --log.level=DEBUG --entrypoints.web.address=:80 --entrypoints.websecure.address=:443 --entrypoints.web.http.redirections.entrypoint.to=websecure --entrypoints.web.http.redirections.entrypoint.scheme=https --certificatesresolvers.letsencrypt.acme.email=$LETSENCRYPT_EMAIL_VALUE --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
            
            echo "✅ Traefik booted successfully with SSL configuration"

      - run:
          name: Deploy Application
          command: |
            kamal deploy --skip-push

workflows:
  main:
    jobs:
      - deploy          
